## 关于项目的一些思考
Q. 究竟啥是负载均衡啊？
- 对于目前的应用而言,几乎离不开集群部署,不论是采用单体架构多副本部署还是微服务架构,不论是为了实现高可用还是高性能,都需要利用多台机器来扩展服务能力

- 比如对于用户的请求不管连接到哪台机器上,都能得到相同的处理

- 如何构建和调度服务集群这件事情,必须对用户保持足够的透明,即使请求背后是由非常多台机器共同响应,也并不是用户关心的事,用户只需要记住一个域名地址而已

- 调用后方的多台机器,以统一的接口对外提供服务,承担此职能的技术组件被称为**负载均衡**

- 一般来说负载均衡背后对应一个服务器农场,由这个负载均衡器来选择一个服务器的ip和port返回给客户端,避免了客户端直接和服务器进行交互,从而对服务器进行一个攻击(高频访问),保障了服务器的安全

- 同时负载均衡也可以降低客户端的一个等待时间,比如有多个客户端,这多个客户端可以通过负载均衡器快速得到可用的节点,如果这多个客户同时访问一个节点那么就会导致这个节点过载,影响客户端的体验

- 负载均衡器通过负载均衡调度算法,在内网服务器中选择一个服务器返回给客户端,这里就需要判断服务器的一个状态,防止其过载或失效导致应用程序的可靠性降低

- 项目中的负载均衡调度算法,只是对每一个服务器农场中的服务器封装一个host_info类,里面保存了调用的一些属性,比如虚成功/失败,真实成功/失败,连续成功/失败的次数,同时维护一个时间戳,表示我们只关心一段时间服务器的状态

- 当客户端向负载均衡器发送请求时,由其向两个队列中通过相应的算法选择一个服务器的ip和port返回给客户端,同时对相应的host_info中的属性进行一个修改,修改完毕之后,根据配置文件中的比率来判断当前服务器是否过载,从而再对两个队列进行操作

- 本项目中,如果有服务器发生故障,而并没有从数据库中删除相应的信息,就会一直处于过载队列中,除非信息从数据库中被删除

Q. 啥是流量分发啊?
- 负载均衡器本身就具有流量分发的功能没有问题,是为了解决服务端流量过大导致宕机

- 如果没有适当的设计和冗余,负载均衡器也可能因为流量过大而宕机

- 为了确保**高可用**和**可靠性**,在均衡器部署和管理的时候通常会采取一些策略防止崩溃
    1. 负载均衡器的冗余部署
        - 就是使用多个负载均衡器,分摊流量和提高可靠性
        - 主备模式/主主模式/分层架构
    2. 弹性伸缩
        - 根据流量自动增加或减少负载均衡器的数量
    3. 流量限制和保护机制
        - 为了防止DDoS攻击
        - 速率限制
        - 健康检查
        - 流量优先级和策略

Q. 为啥非得要负载均衡器啊?
- 假设在DNS服务器上采用轮询的方式()向客户端提供IP + Port,既然如此,为什么还需要负载均衡器?
- 虽然DNS服务器可以分发流量,但是它远远不能替代现代负载均衡器的功能

Q. 为啥啊?
- **更精细的流量管理和分配**
    1. 基于服务器负载的分配:负载均衡器实时监控每台服务器的负载情况,并基于当前服务器负载分配流量
    2. 基于内容的路由:七层负载均衡器可以基于请求的内容(URL/HTTP)进行流量分配
    3. 会话保持:负载均衡器会根据会话信息确保同一用户的请求总是转发到同一个服务器,在(电商购物/在线银行等)非常重要
- **高可用和故障切换**
    1. DNS轮询没有内置的健康检查机制,比如有个服务器故障了,DNS服务器无法自动检测和剔除该服务器,会造成服务中断
    2. 负载均衡器一般会提供健康检查功能,比如实时检测后端服务器的健康状况,确保服务的连续性
    3. 负载均衡器一般可以自动故障切换,多台负载均衡配置的环境下,负载均衡器之间也可以相互协作,当一个负载均衡器发生故障时,其他的接管流量
- **SSL卸载与安全功能**
    1. 在负载均衡器上处理SSL加密和解密工作,减轻后端服务器的负载
    2. 负载均衡提供Web应用防火墙:保护应用免受常见攻击(SQL注入,XSS)影响
    3. DDoS防护,负载均衡器可以帮助缓解分布式拒绝服务(DDoS)
- **更好的扩展性**
    1. 随便添加或移除后端服务器而无需更改DNS记录或等待DNS缓存更新
    2. 负载均衡器会自动识别新添加的服务器并开始将流量分配给他们

Q. 负载均衡器是怎么自动发现/注册服务器的啊?
- **服务发现**
    1. 基于DNS服务器,当由服务器上线时,会将自己的ip和port注册到DNS服务器,负载均衡器就可以通过后天线程不断查询DNS记录,来添加或删除负载均衡器
    2. 基于API的服务发现,K8s提供服务发现机制,其API自动获取服务器信息,比如K8s中的服务发现通过标签和服务定义来管理Pods和服务
    3. 通过注册中心:使用注册中心来维护服务的注册和发现,新服务器在启动时会向注册中心注册,而负载均衡器则定期查询注册中心获取最新的服务列表
    4. 自动注册:新服务器可以通过自动化脚本或配置管理工具自动注册到负载均衡器中。

Q. 那怎么部署啊？
- 本项目属于反向代理,所以可以**单一节点**,**集群**部署,单一节点表示使用单独一个服务器用来运行load_balance_agent,由其和客户端进行通信,之后再和后端服务器通信
- 集群部署表示为了避免单一节点容易故障,采用多个反向代理服务器组成一个集群,再通过**负载均衡**(套娃),来保障服务的一个可靠性
- 还有**地理分布式**部署,每个反向代理服务器只服务离它近的客户

Q. 啥是四层/七层负载均衡啊？
- OSI的下三层是媒体层,上四层是主机层
- 到了主机层也就谈不上什么流量转发,最多只能做代理
- 这里四层/七层对应的是OSI七层模型中的第四层(传输层)和第七层(应用层)
- 四层负载均衡中的四层表示这些工作模式的共同特点是维持着同一个TCP连接,这些模式主要都是工作在二层(数据链路层),第三层(网络层)上,单纯只处理第四层的数据无法做到负载均衡转发
- 数据链路层负载均衡:修改目的MAC地址,从负载均衡MAC-->真实服务器MAC,那么在IP层对应的客户端IP和负载均衡器IP没有变,所以需要把真实物理服务器集群所有机器的虚拟IP地址(VIP)配置成和负载均衡器的虚拟IP一样,避免负载均衡器网卡带宽成为瓶颈
- 四层负载均衡器都无法胜任需要感知应用层协议的场景
- NAT模式也是一种负载均衡模式
- 四层负载均衡工作模式都属于"转发"
- 七层负载均衡工作模式,工作在四层之后的负载均衡模式无法再进行转发,只能代理
- 七层负载均衡器属于反向代理,设置在服务器上,对客户端来说是透明的
- 七层负载均衡器比四层多一轮TCP握手,有带宽问题
- 由于七层均衡器工作在应用层,可以感知应用层通信的具体内容,通常可以做出更明智的决策

Q. 负载均衡器分为静态和动态,是啥意思啊？

- 本项目是动态负载均衡调度,表示会考虑系统中每台服务器的一个运行状态,当然项目中判断状态的方法较为简单,只是根据相应的比率来判断是否过载

- 而静态负载均衡表示不会关注每台服务器的运行状态,其根据预先确定的计划去分配任务,这样有可能导致个别服务器严重过载,因为这个服务器的处理能力相对来说比较落后

- 动态负载均衡的算法一般都有最少连接,加权最少连接,基于资源和地理位置等相关算法,本项目中并没有统计服务器对应的客户端的链接数量,只是通过是否返回成功以及窗口来判断,这样是比较低效的

Q. 都有啥负载均衡策略啊？
- 轮询均衡
- 权重轮循均衡:根据服务器的不同处理能力,给每个服务器分配不同的权值,使其能够接受相应权值数的服务请求
- 随机均衡
- 权重随机均衡(分配请求时是随机选择的)
- 一致性哈希均衡:根据参数作为特征值来计算需要落在的节点
- 响应速度均衡:负载均衡设备对内部服务器发送探测请求(例如ping),根据响应时间(负载均衡到服务器)来决定
- 最少连接均衡:适合长时处理的请求服务,FTP传输

- 软件均衡器:内核的LVS(Linux Virtual Server),应用程序形式(Nginx,HAProxy,KeepAlived),前面的性能好,后面的使用方便,不受限于内核版本

Q. 集成协程有啥用？系统究竟是如何部署的？
- !!没啥用(存疑),协程的应用场景是高并发IO异步,负载均衡器运行在服务器上(并非客户端,每台服务器都有相应的ip和port),也就意味着IO操作并不多,那么瓶颈就不可能出现在IO上

- 本项目而言的话,可以单一部署在单独的服务器上,也可以集群部署,也可以部署在客户端
- 如果是单一部署或者集群部署,网络IO是瓶颈同时CPU也是瓶颈,如果单独部署在客户端,只为单独一个客户提供服务,那也就不存在高并发IO,所以瓶颈在CPU上

- 本项目其实是七层负载均衡器,运行在应用层,所以一般部署在
    1. 数据中心边缘(与防火墙和网关相邻)
    2. 应用服务器前端(比如其根据URL中的DNS得到不同的ip+port,分发给不同的应用服务器)
    3. 云服务提供商的前端(作为一个托管服务,位于云环境的公共入口,处理所有进入的应用层请求)
    4. 多个地理位置的负载均衡器前端

Q. 系统究竟是CPU密集型还是IO密集型的?
- **CPU密集型任务**
    1. 内容解析
    2. SSL/TLS加密解密
    3. 会话保持
    4. 负载均衡算法

- **IO密集型任务**
    1. 网络流量处理
    2. 连接管理
    3. 日志记录和监控

- 综上所述,对于七层负载均衡器而言,CPU和IO都可能是性能的瓶颈
- 所以集成的协程其实非常有用,**高效的并发处理**,**简化异步编程**,**提高系统吞吐量**

- 很直观的那就是在后台线程上,后台线程长时间运行,并且在项目中经常是通过睡几秒来判断一次条件,这样其仍然是占据CPU执行的,所以协程的作用很有用,睡多长时间就可以节省多长CPU时间

Q. 区分Agent、Client、Route
- Agent
	- 所谓的Agent指的是代理,分为反向代理和边缘代理,本项目属于反向代理,服务器的ip和port对用户是透明的,而边缘代理一般部署在靠近客户端处,目的是优化客户体验,减小延迟
		Agent不直接发起请求,而是管理请求的分发
- Client
  	- 所谓的Client指的是客户端,可以是浏览器、应用程序、桌面程序等
- Route
  	- 所谓的Route指的是路由,目的是管理消息的分发 
